{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <h2>Create Agreement</h2>
        <div class="alert alert-info mb-3">
            <h5>Voice Input Instructions:</h5>
            <ul class="mb-0">
                <li>Make sure you're using a modern browser (Chrome recommended)</li>
                <li>Allow microphone access when prompted by your browser</li>
                <li>If denied, use the "Retry Microphone Access" button or enable it in your browser settings</li>
                <li>Speak clearly and at a normal pace</li>
                <li>Use the Stop button when you're done speaking</li>
            </ul>
        </div>
        <form method="POST" id="agreementForm">
            <div class="mb-3">
                <label class="form-label">Select Template</label>
                <div class="d-flex gap-2 mb-2">
                    <select class="form-select" id="templateSelect">
                        <option value="">Choose a template...</option>
                    </select>
                    <button type="button" id="loadTemplate" class="btn btn-secondary">
                        <i class="bi bi-file-earmark-text"></i> Load Template
                    </button>
                </div>
                <div id="templateFeedback" class="alert d-none"></div>
                <div id="templateMatchesSection" class="d-none mb-3">
                    <h6 class="mb-3">Template Matches</h6>
                    <div id="templateMatches" class="row g-2"></div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Agreement Content</label>
                <div class="d-flex gap-2 mb-2">
                    <button type="button" id="startVoice" class="btn btn-secondary" disabled>
                        <i class="bi bi-mic-fill"></i> Start Voice Input
                    </button>
                    <button type="button" id="stopVoice" class="btn btn-danger" disabled>
                        <i class="bi bi-stop-fill"></i> Stop Voice Input
                    </button>
                </div>
                <textarea class="form-control" name="content" id="content" rows="15" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Create Agreement</button>
        </form>
    </div>
    <div class="col-md-6">
        <div class="sticky-top pt-3">
            <h3>Real-time Analysis</h3>
            <div class="card mb-3">
                <div class="card-body position-relative">
                    <div id="previewSpinner" class="position-absolute w-100 h-100 top-0 start-0 d-none">
                        <div class="d-flex justify-content-center align-items-center h-100 bg-dark bg-opacity-25">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div id="previewContent">
                        <p class="text-muted">Start typing to see the preview...</p>
                    </div>
                </div>
            </div>
            <div id="analysisSection" class="d-none">
                <div class="accordion" id="analysisAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#industryContext">
                                Industry Context
                            </button>
                        </h2>
                        <div id="industryContext" class="accordion-collapse collapse show" data-bs-parent="#analysisAccordion">
                            <div class="accordion-body">
                                <div id="industryDetails"></div>
                                <div id="terminologyList" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#keyTerms">
                                Key Terms
                            </button>
                        </h2>
                        <div id="keyTerms" class="accordion-collapse collapse" data-bs-parent="#analysisAccordion">
                            <div class="accordion-body" id="keyTermsList"></div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#riskAssessment">
                                Risk Assessment
                            </button>
                        </h2>
                        <div id="riskAssessment" class="accordion-collapse collapse" data-bs-parent="#analysisAccordion">
                            <div class="accordion-body" id="riskList"></div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#compliance">
                                Compliance & Jurisdiction
                            </button>
                        </h2>
                        <div id="compliance" class="accordion-collapse collapse" data-bs-parent="#analysisAccordion">
                            <div class="accordion-body" id="complianceList"></div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#suggestions">
                                Improvement Suggestions
                            </button>
                        </h2>
                        <div id="suggestions" class="accordion-collapse collapse" data-bs-parent="#analysisAccordion">
                            <div class="accordion-body" id="suggestionsList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template Preview Modal -->
<div class="modal fade" id="templatePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Template Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="templatePreviewContent"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/voice.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const templateSelect = document.getElementById('templateSelect');
    const loadTemplateBtn = document.getElementById('loadTemplate');
    const contentArea = document.getElementById('content');
    const previewContent = document.getElementById('previewContent');
    const previewSpinner = document.getElementById('previewSpinner');
    const analysisSection = document.getElementById('analysisSection');
    const templateFeedback = document.getElementById('templateFeedback');
    const templateMatchesSection = document.getElementById('templateMatchesSection');
    const templateMatches = document.getElementById('templateMatches');
    
    // Analysis section elements
    const industryDetails = document.getElementById('industryDetails');
    const terminologyList = document.getElementById('terminologyList');
    const keyTermsList = document.getElementById('keyTermsList');
    const riskList = document.getElementById('riskList');
    const complianceList = document.getElementById('complianceList');
    const suggestionsList = document.getElementById('suggestionsList');
    
    let templates = {};
    let suggestionTimeout = null;
    let analysisTimeout = null;

    function showPreviewSpinner(show = true) {
        if (show) {
            previewSpinner.classList.remove('d-none');
        } else {
            previewSpinner.classList.add('d-none');
        }
    }

    function showTemplateFeedback(message, type) {
        templateFeedback.textContent = message;
        templateFeedback.className = `alert alert-${type}`;
        templateFeedback.classList.remove('d-none');
        setTimeout(() => templateFeedback.classList.add('d-none'), 5000);
    }

    function createTemplateCard(template) {
        const confidencePercent = Math.round(template.confidence_score * 100);
        const confidenceClass = confidencePercent >= 80 ? 'success' : 
                              confidencePercent >= 60 ? 'warning' : 'danger';
        
        return `
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">${template.template_name}</h6>
                        <div class="progress mb-2" style="height: 5px;">
                            <div class="progress-bar bg-${confidenceClass}" 
                                 style="width: ${confidencePercent}%"></div>
                        </div>
                        <p class="small text-muted mb-2">Match Confidence: ${confidencePercent}%</p>
                        <ul class="small mb-2">
                            ${template.matching_factors.map(factor => 
                                `<li>${factor}</li>`
                            ).join('')}
                        </ul>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary preview-template" 
                                    data-template-id="${template.template_id}">
                                Preview
                            </button>
                            <button class="btn btn-sm btn-outline-success use-template"
                                    data-template-id="${template.template_id}">
                                Use Template
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function updateAnalysis(data) {
        // Update industry context
        if (data.industry_context) {
            industryDetails.innerHTML = `
                <div class="alert alert-info mb-2">
                    <strong>Industry:</strong> ${data.industry_context.industry}
                </div>
                <h6 class="mb-2">Industry-Specific Terminology:</h6>
                ${data.industry_context.terminology.map(term => 
                    `<div class="mb-2">
                        <strong>${term.term}</strong>: ${term.explanation}
                    </div>`
                ).join('')}
            `;
        }

        // Update key terms with risk levels
        if (data.key_terms) {
            keyTermsList.innerHTML = data.key_terms.map(term => {
                const riskClass = {
                    high: 'danger',
                    medium: 'warning',
                    low: 'success'
                }[term.risk_level] || 'info';
                
                return `
                    <div class="mb-3">
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <strong>${term.term}</strong>
                            <span class="badge bg-${riskClass}">${term.risk_level} risk</span>
                        </div>
                        <p class="mb-1">${term.definition}</p>
                        <small class="text-muted">${term.context}</small>
                    </div>
                `;
            }).join('');
        }

        // Update risk assessment
        if (data.risk_highlights) {
            riskList.innerHTML = data.risk_highlights.map(risk => {
                const severityClass = {
                    high: 'danger',
                    medium: 'warning',
                    low: 'success'
                }[risk.severity] || 'info';
                
                return `
                    <div class="alert alert-${severityClass} mb-2">
                        <h6 class="alert-heading">${risk.risk_type}</h6>
                        <p class="mb-1">${risk.text}</p>
                        <small><strong>Mitigation:</strong> ${risk.mitigation}</small>
                    </div>
                `;
            }).join('');
        }

        // Update compliance analysis
        if (data.compliance_analysis) {
            complianceList.innerHTML = `
                <div class="mb-3">
                    <h6>Jurisdiction</h6>
                    <p>${data.compliance_analysis.jurisdiction}</p>
                </div>
                <div class="mb-3">
                    <h6>Compliance Requirements</h6>
                    <ul>
                        ${data.compliance_analysis.requirements.map(req => 
                            `<li>${req}</li>`
                        ).join('')}
                    </ul>
                </div>
                <div class="mb-3">
                    <h6>Compliance Gaps</h6>
                    ${data.compliance_analysis.gaps.map(gap =>
                        `<div class="alert alert-warning mb-2">${gap}</div>`
                    ).join('')}
                </div>
            `;
        }

        // Update suggestions
        if (data.improvements) {
            suggestionsList.innerHTML = data.improvements.map(improvement => {
                const priorityClass = {
                    high: 'danger',
                    medium: 'warning',
                    low: 'success'
                }[improvement.priority] || 'info';
                
                return `
                    <div class="alert alert-${priorityClass} mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-${priorityClass}">${improvement.type}</span>
                            <small>Priority: ${improvement.priority}</small>
                        </div>
                        <p class="mb-0 mt-2">${improvement.suggestion}</p>
                    </div>
                `;
            }).join('');
        }

        analysisSection.classList.remove('d-none');
    }

    function loadSelectedTemplate() {
        const selectedTemplate = templateSelect.value;
        if (selectedTemplate) {
            showPreviewSpinner(true);
            showTemplateFeedback('Loading template...', 'info');

            fetch(`/templates/${selectedTemplate}`)
                .then(response => response.json())
                .then(data => {
                    if (data.content) {
                        contentArea.value = data.content;
                        previewContent.innerHTML = data.content.replace(/\n/g, '<br>');
                        updatePreviewAndAnalysis();
                        showTemplateFeedback('Template loaded successfully!', 'success');
                    }
                })
                .catch(error => {
                    console.error('Error loading template:', error);
                    showTemplateFeedback('Error loading template content.', 'danger');
                })
                .finally(() => showPreviewSpinner(false));
        }
    }

    function updatePreviewAndAnalysis() {
        const content = contentArea.value.trim();
        
        if (analysisTimeout) {
            clearTimeout(analysisTimeout);
        }
        
        if (!content) {
            previewContent.innerHTML = '<p class="text-muted">Start typing to see the preview...</p>';
            analysisSection.classList.add('d-none');
            return;
        }

        previewContent.innerHTML = content.replace(/\n/g, '<br>');
        
        if (content.length > 20) {
            showPreviewSpinner(true);
            
            analysisTimeout = setTimeout(() => {
                fetch('/analyze-text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.formatted_text) {
                        updateAnalysis(data);
                        
                        // Apply highlighting
                        let highlightedText = data.formatted_text;
                        if (data.highlights) {
                            Object.entries(data.highlights).forEach(([type, elements]) => {
                                elements.forEach(element => {
                                    const regex = new RegExp(element.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                                    highlightedText = highlightedText.replace(
                                        regex,
                                        `<span class="highlight-${type}">${element}</span>`
                                    );
                                });
                            });
                        }
                        previewContent.innerHTML = highlightedText.replace(/\n/g, '<br>');
                    }
                })
                .catch(error => {
                    console.error('Error analyzing text:', error);
                    showTemplateFeedback('Error analyzing text.', 'warning');
                })
                .finally(() => showPreviewSpinner(false));
            }, 1000);
        } else {
            analysisSection.classList.add('d-none');
        }
    }

    // Get template suggestions based on user input
    contentArea.addEventListener('input', () => {
        updatePreviewAndAnalysis();
        
        if (suggestionTimeout) {
            clearTimeout(suggestionTimeout);
        }
        
        suggestionTimeout = setTimeout(() => {
            const content = contentArea.value.trim();
            if (content.length > 20) {
                showPreviewSpinner(true);
                
                fetch('/suggest-template', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.template_matches && data.template_matches.length > 0) {
                        templateMatches.innerHTML = data.template_matches
                            .map(template => createTemplateCard(template))
                            .join('');
                        templateMatchesSection.classList.remove('d-none');
                        
                        // Set up event listeners for template cards
                        document.querySelectorAll('.preview-template').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const templateId = btn.dataset.templateId;
                                // Show template preview in modal
                                const modal = new bootstrap.Modal(document.getElementById('templatePreviewModal'));
                                fetch(`/templates/${templateId}`)
                                    .then(response => response.json())
                                    .then(data => {
                                        document.getElementById('templatePreviewContent').innerHTML = 
                                            data.content.replace(/\n/g, '<br>');
                                        modal.show();
                                    });
                            });
                        });
                        
                        document.querySelectorAll('.use-template').forEach(btn => {
                            btn.addEventListener('click', () => {
                                templateSelect.value = btn.dataset.templateId;
                                loadSelectedTemplate();
                            });
                        });
                    } else {
                        templateMatchesSection.classList.add('d-none');
                    }
                })
                .catch(error => {
                    console.error('Error getting suggestions:', error);
                    templateMatchesSection.classList.add('d-none');
                })
                .finally(() => showPreviewSpinner(false));
            }
        }, 1000);
    });

    // Load templates on page load
    fetch('/templates')
        .then(response => response.json())
        .then(templatesData => {
            templatesData.forEach(template => {
                templates[template.id] = template;
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.name;
                templateSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading templates:', error);
            showTemplateFeedback('Error loading templates.', 'danger');
        });

    // Event listeners
    templateSelect.addEventListener('change', loadSelectedTemplate);
    loadTemplateBtn.addEventListener('click', loadSelectedTemplate);
});
</script>

<style>
.highlight-amounts {
    background-color: var(--bs-warning-bg-subtle);
    padding: 0 2px;
    border-radius: 2px;
}

.highlight-dates {
    background-color: var(--bs-info-bg-subtle);
    padding: 0 2px;
    border-radius: 2px;
}

.highlight-names {
    background-color: var(--bs-success-bg-subtle);
    padding: 0 2px;
    border-radius: 2px;
}

.highlight-legal_terms {
    background-color: var(--bs-primary-bg-subtle);
    padding: 0 2px;
    border-radius: 2px;
}

.highlight-obligations {
    background-color: var(--bs-danger-bg-subtle);
    padding: 0 2px;
    border-radius: 2px;
}

.highlight-conditions {
    background-color: var(--bs-secondary-bg-subtle);
    padding: 0 2px;
    border-radius: 2px;
}

#previewContent {
    min-height: 200px;
}

.template-card {
    transition: transform 0.2s;
}

.template-card:hover {
    transform: translateY(-2px);
}
</style>
{% endblock %}
